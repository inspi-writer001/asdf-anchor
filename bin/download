#!/usr/bin/env bash
set -euo pipefail

GH_REPO="https://github.com/solana-foundation/anchor"
TOOL_NAME="anchor"

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")
source "${plugin_dir}/lib/utils.bash"

mkdir -p "$ASDF_DOWNLOAD_PATH"

# Detect system arch
arch="$(uname -m)"
os="$(uname -s)"

case "$arch" in
  x86_64) arch="x86_64" ;;
  aarch64 | arm64) arch="aarch64" ;;
  *) fail "Unsupported architecture: $arch" ;;
esac

case "$os" in
  Linux) os="unknown-linux-gnu" ;;
  Darwin) os="apple-darwin" ;;
  MINGW*|MSYS*|CYGWIN*|Windows_NT) os="pc-windows-msvc.exe" ;;
  *) fail "Unsupported OS: $os" ;;
esac

filename="${TOOL_NAME}-${ASDF_INSTALL_VERSION}-${arch}-${os}"
download_url="${GH_REPO}/releases/download/v${ASDF_INSTALL_VERSION}/${filename}"
dest_file="$ASDF_DOWNLOAD_PATH/${filename}"

echo "Downloading $download_url â†’ $dest_file"
curl -sSL -o "$dest_file" "$download_url"

# Make executable (skip for Windows)
if [[ "$os" != *".exe" ]]; then
  chmod +x "$dest_file"
fi

# Move to install path
mv "$dest_file" "$ASDF_INSTALL_PATH/$TOOL_NAME"
