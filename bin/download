#!/usr/bin/env bash
set -euo pipefail

# resolve script and plugin paths
current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")
source "${plugin_dir}/lib/utils.bash"

GH_REPO="https://github.com/solana-foundation/anchor"
TOOL_NAME="anchor"

# determine version: arg → env → latest-stable
version="${1:-${ASDF_INSTALL_VERSION:-}}"
if [ -z "$version" ]; then
  version="$(bash "${plugin_dir}/bin/latest-stable")"
  echo "No version specified; falling back to latest stable: $version"
fi

# required ASDF paths
download_path="${ASDF_DOWNLOAD_PATH:?Must be set by ASDF}"
install_path="${ASDF_INSTALL_PATH:?Must be set by ASDF}"

mkdir -p "$install_path/bin"

# detect platform
arch="$(uname -m)"
os="$(uname -s)"
case "$arch" in
  x86_64) arch="x86_64" ;;
  aarch64|arm64) arch="aarch64" ;;
  *) fail "Unsupported arch: $arch" ;;
esac
case "$os" in
  Linux) os="unknown-linux-gnu" ;;
  Darwin) os="apple-darwin" ;;
  MINGW*|MSYS*|CYGWIN*|Windows_NT) os="pc-windows-msvc.exe" ;;
  *) fail "Unsupported OS: $os" ;;
esac

# build URLs and paths
filename="${TOOL_NAME}-${version}-${arch}-${os}"
url="${GH_REPO}/releases/download/v${version}/${filename}"
dest="${download_path}/${filename}"

echo "Downloading Anchor v${version} from: $url"
curl -sSL -o "$dest" "$url" || fail "Download failed"

# make executable if not Windows
[[ "$os" != *.exe ]] && chmod +x "$dest"

# move into final install location
mv "$dest" "$install_path/bin/$TOOL_NAME"

echo "Installed Anchor v${version} to: $install_path/bin/$TOOL_NAME"
